<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Exact Vector Match ‚Äî Demo</title>
<style>
  :root{
    --bg:#0b1020; --fg:#e8ecf2; --muted:#9aa7bd; --accent:#8fd3ff; --line:#223252; --card:#141b2f;
    --good:#6ee7b7; --warn:#fbbf24; --bad:#fca5a5;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{font-size:22px;margin:0 0 8px}
  .note{color:var(--muted);margin:0 0 12px}
  .panel{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:1000px){.panel{grid-template-columns:1fr}}
  .box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .box h2{font-size:16px;margin:0 0 8px}
  .rows{display:grid;gap:8px}
  .item{display:grid;grid-template-columns:68px 1fr auto;gap:10px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px;background:#0f1629}
  .thumb{font-size:28px;display:grid;place-items:center;background:#0b162b;border:1px solid var(--line);border-radius:8px;height:50px}
  .meta{font-size:13px;color:#cfe0ff}
  .btn{background:#0f1629;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:6px 10px;cursor:pointer}
  .btn.small{padding:4px 8px;font-size:13px}
  .controls .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0}
  input[type=number], textarea, select, button{background:#0f1629;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
  textarea{width:100%;min-height:110px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0f1629;color:#cbd6ea}
  .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .result{border:1px solid var(--line);border-radius:10px;padding:10px;background:#0f1629;margin-top:8px}
  code{background:#0b162b;border:1px solid var(--line);border-radius:8px;padding:2px 6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Exact Vector Match</h1>
  <div class="note">Click any stored item to copy its exact vector into the query. <b>Exact Match</b> returns only if every coordinate matches (after rounding tolerance). Otherwise, try <b>Nearest Neighbor</b>.</div>

  <div class="panel">
    <!-- LEFT: Stored items -->
    <div class="box">
      <h2>Stored Items (Vector DB)</h2>
      <div class="rows" id="dbList"></div>
    </div>

    <!-- RIGHT: Query -->
    <div class="box controls">
      <h2>Query Vector</h2>
      <div class="row">
        <span class="pill">Dimensionality: <b id="dimLbl">8</b></span>
        <label>Rounding (decimals): <input id="roundDec" type="number" min="0" max="6" step="1" value="4"/></label>
        <label>Noise: <input id="noise" type="number" step="0.0001" value="0.0000"/></label>
        <button class="btn small" id="applyNoise" title="Add ¬±noise to each coordinate">Apply noise</button>
      </div>
      <textarea id="query" spellcheck="false" aria-label="Query vector JSON"></textarea>
      <div class="row">
        <button class="btn" id="btnExact">Exact Match</button>
        <button class="btn" id="btnNN">Nearest Neighbor</button>
        <label>Metric:
          <select id="metric">
            <option value="cosine">Cosine</option>
            <option value="euclid">Euclidean</option>
          </select>
        </label>
        <label>Top-K:
          <select id="topk"><option>1</option><option selected>3</option><option>5</option></select>
        </label>
      </div>
      <div id="out" class="result">‚Äî</div>
    </div>
  </div>
</div>

<script>
/* ---------- Tiny synthetic ‚ÄúDB‚Äù ---------- */
function rnd(){ return Math.random(); }
function norm(v){ let s=0; for(const x of v) s+=x*x; s=Math.sqrt(s)||1; return v.map(x=>x/s); }

const D = 8; // dimensionality
const DB = [
  { id:'img-puppy',   label:'üê∂ Puppy in flowers',     vec: norm([0.8,0.6,0.1,0.0,0.2,0.1,0.5,0.4]) },
  { id:'img-tulips',  label:'üå∑ Tulips close-up',      vec: norm([0.0,0.7,0.9,0.1,0.1,0.2,0.0,0.3]) },
  { id:'txt-dog',     label:'Text: ‚Äúfriendly dog‚Äù',    vec: norm([0.7,0.4,0.0,0.1,0.3,0.2,0.6,0.2]) },
  { id:'txt-flowers', label:'Text: ‚Äúpurple flowers‚Äù',  vec: norm([0.1,0.6,0.8,0.2,0.0,0.1,0.1,0.2]) },
  { id:'aud-birds',   label:'Audio: birds in park',    vec: norm([0.2,0.2,0.1,0.7,0.6,0.1,0.0,0.1]) },
  { id:'aud-ocean',   label:'Audio: ocean waves',      vec: norm([0.1,0.1,0.2,0.6,0.8,0.2,0.1,0.0]) },
];

function cosine(a,b){ let num=0,na=0,nb=0; for(let i=0;i<a.length;i++){const x=a[i],y=b[i]; num+=x*y; na+=x*x; nb+=y*y;} na=Math.sqrt(na); nb=Math.sqrt(nb); if(na===0||nb===0) return 0; return num/(na*nb); }
function euclid(a,b){ let s=0; for(let i=0;i<a.length;i++){ const d=a[i]-b[i]; s+=d*d; } return Math.sqrt(s); }

function fmtVec(v, dec=4){ return JSON.stringify(v.map(x=>+x.toFixed(dec))); }
function parseVec(s){ try{ const v=JSON.parse(s); if(Array.isArray(v)&&v.every(n=>typeof n==='number')) return v; }catch(e){} return null; }

/* ---------- Render DB list ---------- */
const dbList = document.getElementById('dbList');
const queryTA = document.getElementById('query');
const dimLbl = document.getElementById('dimLbl');
const roundDec = document.getElementById('roundDec');
const noiseEl = document.getElementById('noise');
const out = document.getElementById('out');

dimLbl.textContent = D;

function renderDB(){
  dbList.innerHTML='';
  DB.forEach((it)=>{
    const row = document.createElement('div'); row.className='item';
    const thumb = document.createElement('div'); thumb.className='thumb'; thumb.textContent = it.label.split(' ')[0];
    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `<div><b>${it.label}</b> <span style="color:#9fb1d3">(${it.id})</span></div>
      <div>vector: <code>${fmtVec(it.vec, 3)}</code></div>`;
    const btns = document.createElement('div');
    const b1 = document.createElement('button'); b1.className='btn small'; b1.textContent='Use this vector';
    b1.addEventListener('click', ()=>{
      queryTA.value = fmtVec(it.vec, parseInt(roundDec.value||'4',10));
      out.innerHTML='Copied this item‚Äôs exact vector into the query.';
    });
    btns.appendChild(b1);
    row.appendChild(thumb); row.appendChild(meta); row.appendChild(btns);
    dbList.appendChild(row);
  });
}
renderDB();

/* ---------- Noise helper ---------- */
function applyNoise(){
  const v = parseVec(queryTA.value); if(!v){ out.innerHTML='<span class="bad">Invalid query JSON.</span>'; return; }
  const eps = parseFloat(noiseEl.value||'0');
  const dec = parseInt(roundDec.value||'4',10);
  for(let i=0;i<v.length;i++){
    v[i] += (Math.random()*2-1)*eps;
  }
  queryTA.value = fmtVec(v, dec);
  out.innerHTML = `Applied ¬±${eps} noise and rounded to ${dec} decimals.`;
}
document.getElementById('applyNoise').addEventListener('click', applyNoise);

/* ---------- Exact match ---------- */
function exactMatch(q, dec=4){
  // Round both DB vectors and query to 'dec' decimals and require equality on every coordinate.
  const rq = q.map(x=>+x.toFixed(dec));
  for(const it of DB){
    const rv = it.vec.map(x=>+x.toFixed(dec));
    let same = true;
    for(let i=0;i<D;i++){ if(rv[i]!==rq[i]){ same=false; break; } }
    if(same) return it;
  }
  return null;
}

/* ---------- Nearest neighbor ---------- */
function nnSearch(q, k=3, metric='cosine'){
  const arr = DB.map((it)=>({
    it,
    s: metric==='cosine' ? cosine(q,it.vec) : euclid(q,it.vec)
  }));
  arr.sort((a,b)=> metric==='cosine' ? (b.s-a.s) : (a.s-b.s));
  return arr.slice(0,k);
}

/* ---------- Wire buttons ---------- */
document.getElementById('btnExact').addEventListener('click', ()=>{
  const q = parseVec(queryTA.value);
  if(!q || q.length!==D){ out.innerHTML='<span class="bad">Please paste a valid JSON array of length '+D+'.</span>'; return; }
  const dec = parseInt(roundDec.value||'4',10);
  const found = exactMatch(q, dec);
  if(found){
    out.innerHTML = `<div><span class="good">Exact match found!</span> ‚Üí <b>${found.label}</b> <span style="color:#9fb1d3">(${found.id})</span></div>
    <div>At rounding = <code>${dec}</code> decimals. Returning the exact stored item.</div>`;
  }else{
    out.innerHTML = `<div><span class="bad">No exact match.</span> Try lowering rounding or using Nearest Neighbor.</div>`;
  }
});

document.getElementById('btnNN').addEventListener('click', ()=>{
  const q = parseVec(queryTA.value);
  if(!q || q.length!==D){ out.innerHTML='<span class="bad">Please paste a valid JSON array of length '+D+'.</span>'; return; }
  const k = parseInt(document.getElementById('topk').value,10);
  const metric = document.getElementById('metric').value;
  const res = nnSearch(q, k, metric);
  const rows = res.map((r,i)=>{
    const score = metric==='cosine' ? `similarity <code>${r.s.toFixed(4)}</code>` : `distance <code>${r.s.toFixed(4)}</code>`;
    return `<div>Top ${i+1}: <b>${r.it.label}</b> <span style="color:#9fb1d3">(${r.it.id})</span> ‚Äî ${score}</div>`;
  }).join('');
  out.innerHTML = `<div class="warn">Nearest Neighbor results (${metric}):</div>${rows || '‚Äî'}`;
});

/* ---------- Seed query with first item's exact vector ---------- */
queryTA.value = fmtVec(DB[0].vec, parseInt(roundDec.value||'4',10));
</script>
</body>
</html>
