<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nearest Neighbor Visualizer (2D)</title>
<style>
  :root{
    --bg:#0b1020; --fg:#e8ecf2; --muted:#9aa7bd; --accent:#8fd3ff; --line:#223252; --card:#141b2f; --grid:#1a2742;
    --query:#73c0ff; --neighbor:#6ee7b7; --other:#bcd1f0;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1000px;margin:0 auto;padding:20px}
  h1{font-size:22px;margin:0 0 8px}
  .note{color:var(--muted);margin:0 0 14px}
  .panel{display:flex;gap:16px;flex-wrap:wrap}
  .left{flex:1 1 640px;min-width:340px}
  .right{flex:1 1 280px;min-width:260px}
  .board{position:relative;height:540px;border:1px solid var(--line);border-radius:12px;background:
    linear-gradient(0deg, transparent 49%, var(--grid) 50%, transparent 51%),
    linear-gradient(90deg, transparent 49%, var(--grid) 50%, transparent 51%);
    background-color:var(--card);
    overflow:hidden;
  }
  .axis{position:absolute;color:#cbd6ea;font-size:12px}
  .axis.x{left:8px;bottom:8px}
  .axis.y{left:8px;top:8px}
  .pt{position:absolute;translate:-50% -50%; display:flex;flex-direction:column;align-items:center;gap:2px}
  .dot{width:18px;height:18px;border-radius:50%;border:2px solid var(--line);background:#0f1629;display:grid;place-items:center}
  .dot span{font-size:13px}
  .label{font-size:11px;color:#b8c7e6;white-space:nowrap;max-width:140px;overflow:hidden;text-overflow:ellipsis}
  .pt button{all:unset;cursor:pointer}
  .pt:focus-within .dot, .pt button:focus{outline:2px solid var(--accent);outline-offset:2px;border-radius:12px}
  .query .dot{background:var(--query)}
  .neighbor .dot{background:var(--neighbor); color:#06301f}
  .other .dot{background:#0f1629}
  canvas.lines{position:absolute;inset:0;pointer-events:none}
  .box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .box h2{font-size:16px;margin:0 0 8px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  select, input[type=number], button, input[type=checkbox]{background:#0f1629;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
  button{cursor:pointer}
  .list{display:grid;gap:8px}
  .krow{display:flex;justify-content:space-between;gap:8px;color:var(--muted)}
  .krow strong{color:#e6eefc}
  .legend{display:flex;gap:12px;align-items:center;margin:8px 0 0}
  .key{display:inline-flex;align-items:center;gap:6px;color:var(--muted)}
  .sw{width:14px;height:14px;border-radius:4px;border:1px solid var(--line)}
  .sw.q{background:var(--query)} .sw.n{background:var(--neighbor)} .sw.o{background:#0f1629}
</style>
</head>
<body>
<div class="wrap">
  <h1>Interactive Nearest Neighbor Visualizer</h1>
  <div class="note">Click a point to set it as the <b>query</b>. Choose a metric and K; the nearest neighbors will highlight. Toggle line overlay to see distances.</div>

  <div class="panel">
    <div class="left">
      <div class="board" id="board" role="application" aria-label="2D vector space">
        <div class="axis x">x</div>
        <div class="axis y">y</div>
        <canvas class="lines" id="lines" width="800" height="540"></canvas>
      </div>
      <div class="legend">
        <span class="key"><span class="sw q swatch"></span> query</span>
        <span class="key"><span class="sw n swatch"></span> neighbor</span>
        <span class="key"><span class="sw o swatch"></span> other</span>
      </div>
    </div>

    <div class="right">
      <div class="box">
        <h2>Search Settings</h2>
        <div class="row">
          <label>Metric:
            <select id="metric">
              <option value="cosine">Cosine similarity</option>
              <option value="euclid">Euclidean distance</option>
            </select>
          </label>
          <label>Top K:
            <input id="topk" type="number" min="1" max="6" step="1" value="3" />
          </label>
        </div>
        <div class="row">
          <label><input id="showLines" type="checkbox" checked> Show lines</label>
          <button id="shuffle">Shuffle Dataset</button>
          <button id="reset">Reset</button>
        </div>
      </div>

      <div class="box">
        <h2>Neighbors</h2>
        <div id="nnList" class="list" aria-live="polite">Click a point to begin.</div>
      </div>

      <div class="box">
        <h2>Selected Query</h2>
        <div id="selInfo" class="krow">None selected</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Utilities ---------- */
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
function cosine(a,b){
  const dot=a[0]*b[0]+a[1]*b[1];
  const na=Math.hypot(a[0],a[1]), nb=Math.hypot(b[0],b[1]);
  if(na===0||nb===0) return 0;
  return dot/(na*nb);
}
function euclid(a,b){ return Math.hypot(a[0]-b[0],a[1]-b[1]); }
function rnd(n=1){ return Math.random()*n; }
function lerp(a,b,t){ return a+(b-a)*t; }

/* ---------- Data (clusters + labels) ---------- */
const BASE = [
  { id:'A', emoji:'🐶', label:'dog on grass',       vec:[0.78,0.22] },
  { id:'B', emoji:'🐶🌸', label:'puppy in flowers',  vec:[0.70,0.86] },
  { id:'C', emoji:'🌸',   label:'tulip bed',         vec:[0.11,0.93] },
  { id:'D', emoji:'🌳',   label:'park bench',        vec:[0.20,0.30] },
  { id:'E', emoji:'🏖️',  label:'beach scene',       vec:[0.05,0.12] },
  { id:'F', emoji:'🐕',   label:'dog indoors',       vec:[0.83,0.10] },
  { id:'G', emoji:'🌺',   label:'hibiscus close-up', vec:[0.18,0.78] },
  { id:'H', emoji:'🐾',   label:'dog footprints',    vec:[0.62,0.35] },
];

/* jitter copy for visual variety */
function withJitter(base, amt=0.03){
  return base.map(x=>{
    const jx = clamp(x.vec[0]+(Math.random()*2-1)*amt,0,1);
    const jy = clamp(x.vec[1]+(Math.random()*2-1)*amt,0,1);
    return { ...x, vec:[jx,jy] };
  });
}

let DATA = withJitter(BASE);
let queryId = null;

const board = document.getElementById('board');
const lines = document.getElementById('lines');
const ctx = lines.getContext('2d');

function W(){ return board.clientWidth; }
function H(){ return board.clientHeight; }
function xyToPx([x,y]){ return [x*W(), (1-y)*H()]; }

const nodes = new Map(); // id -> {el, data}

/* ---------- Rendering Points ---------- */
function renderPoints(){
  board.querySelectorAll('.pt').forEach(n=>n.remove());
  DATA.forEach(d=>{
    const holder = document.createElement('div');
    holder.className='pt other';
    holder.style.left = xyToPx(d.vec)[0]+'px';
    holder.style.top  = xyToPx(d.vec)[1]+'px';

    const btn = document.createElement('button');
    btn.className='dot'; btn.title = `${d.id}: ${d.label}`;
    btn.setAttribute('aria-label', `${d.id}: ${d.label}`);
    btn.innerHTML = `<span>${d.emoji}</span>`;
    btn.addEventListener('click', ()=> setQuery(d.id));

    const lab = document.createElement('div');
    lab.className='label'; lab.textContent = `${d.id} • ${d.label}`;

    holder.appendChild(btn);
    holder.appendChild(lab);
    board.appendChild(holder);

    nodes.set(d.id, {el:holder, data:d});
  });
  recolor();
  resizeCanvas();
}

/* ---------- Selection & Neighbors ---------- */
function setQuery(id){
  queryId = id;
  const q = DATA.find(x=>x.id===id);
  // animate query point pulse
  const el = nodes.get(id).el;
  el.animate(
    [{transform:'translate(-50%,-50%) scale(1.0)'},{transform:'translate(-50%,-50%) scale(1.08)'},{transform:'translate(-50%,-50%) scale(1.0)'}],
    {duration:400}
  );
  updateNN();
}

function recolor(highlightIds=[]){
  nodes.forEach((v,k)=>{
    v.el.classList.remove('query','neighbor','other');
    if(k===queryId) v.el.classList.add('query');
    else if(highlightIds.includes(k)) v.el.classList.add('neighbor');
    else v.el.classList.add('other');
  });
}

function updateNN(){
  const listEl = document.getElementById('nnList');
  const infoEl = document.getElementById('selInfo');
  if(!queryId){
    listEl.textContent = 'Click a point to begin.'; infoEl.textContent='None selected';
    drawLines([]); return;
  }
  const q = DATA.find(x=>x.id===queryId).vec;
  const metric = document.getElementById('metric').value;
  const k = Math.max(1, Math.min(6, parseInt(document.getElementById('topk').value||3,10)));

  let scored = DATA.filter(d=>d.id!==queryId).map(d=>{
    if(metric==='cosine'){
      return { id:d.id, label:d.label, score: cosine(q,d.vec) }; // higher better
    } else {
      return { id:d.id, label:d.label, score: euclid(q,d.vec) }; // lower better
    }
  });

  scored.sort((a,b)=> metric==='cosine' ? (b.score-a.score) : (a.score-b.score));
  const top = scored.slice(0,k);

  // UI: list
  listEl.innerHTML = top.map(t=>{
    const val = (metric==='cosine') ? t.score.toFixed(3) : t.score.toFixed(3);
    return `<div class="krow"><strong>${t.id}</strong><span>${t.label}</span><span><code>${val}</code></span></div>`;
  }).join('');

  // UI: selected panel
  infoEl.innerHTML = `<div class="krow"><strong>${queryId}</strong><span>metric: ${metric}, K=${k}</span></div>`;

  // recolor + lines
  const ids = top.map(t=>t.id);
  recolor(ids);
  drawLines(ids);
}

/* ---------- Lines Overlay ---------- */
function resizeCanvas(){
  lines.width = board.clientWidth;
  lines.height= board.clientHeight;
  drawLines([]);
}
window.addEventListener('resize', resizeCanvas);

function drawLines(ids){
  const show = document.getElementById('showLines').checked;
  ctx.clearRect(0,0,lines.width,lines.height);
  if(!show || !queryId) return;

  const q = DATA.find(x=>x.id===queryId).vec;
  const [qx,qy] = xyToPx(q);
  ids.forEach(id=>{
    const v = DATA.find(x=>x.id===id).vec;
    const [vx,vy] = xyToPx(v);
    ctx.beginPath();
    ctx.moveTo(qx,qy);
    ctx.lineTo(vx,vy);
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(110,231,183,0.9)'; // neighbor color
    ctx.stroke();

    // dot markers
    ctx.beginPath(); ctx.arc(qx,qy,4,0,Math.PI*2); ctx.fillStyle='#73c0ff'; ctx.fill();
    ctx.beginPath(); ctx.arc(vx,vy,4,0,Math.PI*2); ctx.fillStyle='#6ee7b7'; ctx.fill();
  });
}

/* ---------- Dataset Controls ---------- */
function shuffleDataset(){
  // randomly re-spread around their original cluster centers
  const out = BASE.map((b,i)=>{
    const t = Math.random();
    const nx = clamp(lerp(b.vec[0], Math.random(), 0.15), 0, 1);
    const ny = clamp(lerp(b.vec[1], Math.random(), 0.15), 0, 1);
    return { ...b, vec:[nx,ny] };
  });
  DATA = withJitter(out, 0.02);
  queryId = null;
  renderPoints();
  updateNN();
}
function resetDataset(){
  DATA = withJitter(BASE, 0.03);
  queryId = null;
  renderPoints();
  updateNN();
}

/* ---------- Hooks ---------- */
document.getElementById('metric').addEventListener('change', updateNN);
document.getElementById('topk').addEventListener('change', updateNN);
document.getElementById('showLines').addEventListener('change', ()=>drawLines([]) || updateNN());
document.getElementById('shuffle').addEventListener('click', shuffleDataset);
document.getElementById('reset').addEventListener('click', resetDataset);

/* ---------- Init ---------- */
renderPoints();
</script>
</body>
</html>