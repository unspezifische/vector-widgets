<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Multimodal Embeddings ‚Äî Image ‚Ä¢ Text ‚Ä¢ Audio</title>
<style>
  :root{
    --bg:#0b1020; --fg:#e8ecf2; --muted:#9aa7bd; --accent:#8fd3ff; --line:#223252; --card:#141b2f;
    --img:#7dd3fc; --txt:#86efac; --aud:#fca5a5; --bars:#bcd1f0;
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{font-size:22px;margin:0 0 6px}
  .tabs{display:flex;gap:8px;margin:8px 0 14px}
  .tabs button{background:#0f1629;color:var(--fg);border:1px solid var(--line);border-radius:999px;padding:8px 12px;cursor:pointer}
  .tabs button[aria-pressed="true"]{background:var(--line)}
  .grid{display:grid;grid-template-columns:1.05fr 0.95fr;gap:16px}
  @media (max-width:1020px){.grid{grid-template-columns:1fr}}
  .box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .box h2{font-size:16px;margin:0 0 8px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0}
  label{color:#cbd6ea}
  input[type=file], input[type=text], button, select{background:#0f1629;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
  textarea{background:#0f1629;color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:10px;width:100%;min-height:100px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .thumb{display:grid;place-items:center;background:#0f1629;border:1px solid var(--line);border-radius:12px;overflow:hidden;aspect-ratio:1/1;position:relative}
  .cap{position:absolute;left:8px;top:8px;background:#0f1629;border:1px solid var(--line);border-radius:8px;padding:2px 8px;color:#cbd6ea}
  canvas.thumbCv{width:100%;height:100%}
  .legend{color:#9fb1d3;font-size:12px;margin-top:6px}
  .chart{height:220px;width:100%;background:#0f1629;border:1px solid var(--line);border-radius:12px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:#cbd6ea;background:#0f1629}
  .list{display:grid;gap:6px;margin-top:6px}
  .item{display:flex;justify-content:space-between;gap:10px}
  code{background:#0f1629;border:1px solid var(--line);border-radius:8px;padding:2px 6px}
  .note{color:var(--muted);margin:0 0 10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Multimodal Embeddings ‚Äî Image ‚Ä¢ Text ‚Ä¢ Audio</h1>
  <div class="note">Switch modalities, generate an embedding, and compare nearest neighbors using cosine similarity. Embeddings here are simple, transparent demos‚Äînot production models.</div>

  <div class="tabs" role="tablist" aria-label="Modalities">
    <button class="tab" data-tab="image" aria-pressed="true">Image</button>
    <button class="tab" data-tab="text" aria-pressed="false">Text</button>
    <button class="tab" data-tab="audio" aria-pressed="false">Audio</button>
  </div>

  <div class="grid">
    <!-- LEFT: input & presets -->
    <div class="box">
      <h2 id="leftTitle">Image Input</h2>

      <!-- IMAGE INPUT -->
      <div class="imagePane">
        <div class="row">
          <label>Upload image: <input id="imgUp" type="file" accept="image/*"/></label>
          <label>Grid:
            <select id="imgGrid">
              <option value="4">4√ó4</option>
              <option value="8" selected>8√ó8</option>
            </select>
          </label>
          <label>Quantize (decimals): <select id="imgQuant"><option>0</option><option>1</option><option selected>2</option><option>3</option></select></label>
          <button id="imgCompute">Embed</button>
        </div>
        <div class="two">
          <div class="thumb"><div class="cap">Image</div><canvas id="imgCanvas" class="thumbCv" width="256" height="256"></canvas></div>
          <div>
            <div class="note">Presets:</div>
            <div class="row">
              <button data-preset="tulips">üå∏ Tulips</button>
              <button data-preset="puppy">üê∂ Puppy</button>
              <button data-preset="checker">Checker</button>
              <button data-preset="gradient">Gradient</button>
            </div>
          </div>
        </div>
        <div class="legend">Embedding = average RGB per cell ‚Üí <code>grid√ógrid√ó3</code> numbers in [0,1].</div>
      </div>

      <!-- TEXT INPUT -->
      <div class="textPane" hidden>
        <div class="row">
          <label>Hash dims: <select id="txtDims"><option>32</option><option selected>64</option><option>128</option></select></label>
          <label>Lowercase + strip punctuation <input id="txtClean" type="checkbox" checked/></label>
          <button id="txtCompute">Embed</button>
        </div>
        <textarea id="txtArea" placeholder="Type or paste text here‚Ä¶">A puppy plays in a flower garden with bright tulips.</textarea>
        <div class="row">
          <span class="pill">Presets:</span>
          <button data-t="dogs">‚ÄúA friendly golden retriever with a tennis ball.‚Äù</button>
          <button data-t="flowers">‚ÄúA field of purple tulips near sunrise.‚Äù</button>
          <button data-t="park">‚ÄúPeople sitting on a bench in the city park.‚Äù</button>
        </div>
        <div class="legend">Embedding = bag-of-words hashing (character n-grams/words ‚Üí <code>D</code> bins).</div>
      </div>

      <!-- AUDIO INPUT -->
      <div class="audioPane" hidden>
        <div class="row">
          <button id="audMic">üéôÔ∏è Record / Live Input</button>
          <button id="audStop" disabled>Stop</button>
          <label>Bands: <select id="audBands"><option>32</option><option selected>64</option><option>128</option></select></label>
          <button id="audCompute">Embed Snapshot</button>
        </div>
        <div class="row">
          <span class="pill">Presets:</span>
          <button data-a="sine">Sine 440Hz</button>
          <button data-a="chord">Triad Chord</button>
          <button data-a="noise">Noise</button>
        </div>
        <div class="legend">Embedding = FFT magnitude snapshot averaged into <code>B</code> bands.</div>
        <div id="audStatus" class="note">Status: idle</div>
      </div>
    </div>

    <!-- RIGHT: embedding & neighbors -->
    <div class="box">
      <h2>Embedding & Neighbors</h2>
      <div class="row">
        <span id="vecInfo" class="pill">Vector: ‚Äî</span>
        <label>Top-K: <select id="topk"><option>3</option><option selected>5</option><option>8</option></select></label>
        <button id="nnRun">Find Nearest Neighbors</button>
      </div>
      <canvas id="chart" class="chart" width="800" height="220" aria-label="Embedding chart"></canvas>
      <div class="list" id="nnList">‚Äî</div>
    </div>
  </div>
</div>

<script>
/* =============== Common helpers =============== */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function cosine(a,b){
  let num=0,na=0,nb=0; for(let i=0;i<a.length;i++){ const x=a[i], y=b[i]; num+=x*y; na+=x*x; nb+=y*y; }
  if(na===0||nb===0) return 0;
  return num/(Math.sqrt(na)*Math.sqrt(nb));
}
const fmt = n => (Math.round(n*10000)/10000).toFixed(4);

function drawBars(cv, vec, color='#bcd1f0'){
  const ctx=cv.getContext('2d');
  const w=cv.width, h=cv.height;
  ctx.clearRect(0,0,w,h);
  const m=20;
  ctx.fillStyle='#0f1629'; ctx.fillRect(0,0,w,h);
  const n=vec.length;
  const bw = Math.max(1, (w-2*m)/n);
  const maxVal = Math.max(1e-9, ...vec.map(Math.abs));
  ctx.fillStyle=color;
  for(let i=0;i<n;i++){
    const v = vec[i]/maxVal; // scaled
    const bh = v*(h-2*m);
    ctx.fillRect(m + i*bw, h-m-bh, bw*0.9, bh);
  }
  ctx.fillStyle='#9fb1d3'; ctx.font='12px system-ui';
  ctx.fillText(`dim=${n}`, 6, 14);
}

/* =============== IMAGE =============== */
const imgCv = $('#imgCanvas'); const imgCtx = imgCv.getContext('2d');
function drawPresetImage(name){
  const {width:w, height:h} = imgCv;
  imgCtx.fillStyle = '#0f1a2b'; imgCtx.fillRect(0,0,w,h);
  if(name==='tulips'){
    // simple stylized tulip patch
    for(let i=0;i<120;i++){
      imgCtx.fillStyle = `hsl(${280+Math.random()*20},70%,${45+Math.random()*20}%)`;
      const x=Math.random()*w, y=h*0.5 + Math.random()*h*0.45;
      imgCtx.beginPath(); imgCtx.ellipse(x,y,4+Math.random()*4,8+Math.random()*8,0,0,Math.PI*2); imgCtx.fill();
      imgCtx.strokeStyle='#2a7f3f'; imgCtx.beginPath(); imgCtx.moveTo(x,y); imgCtx.lineTo(x,y-16); imgCtx.stroke();
    }
  }else if(name==='puppy'){
    // emoji-ish: circle face + ears
    imgCtx.fillStyle='#f5deb3'; imgCtx.beginPath(); imgCtx.arc(w*0.5,h*0.55,60,0,Math.PI*2); imgCtx.fill();
    imgCtx.fillStyle='#5c3b1a';
    imgCtx.beginPath(); imgCtx.arc(w*0.43,h*0.45,30,0,Math.PI*2); imgCtx.fill();
    imgCtx.beginPath(); imgCtx.arc(w*0.57,h*0.45,30,0,Math.PI*2); imgCtx.fill();
    imgCtx.fillStyle='#000'; imgCtx.beginPath(); imgCtx.arc(w*0.5,h*0.58,12,0,Math.PI*2); imgCtx.fill();
  }else if(name==='checker'){
    const s=32; for(let y=0;y<h;y+=s){ for(let x=0;x<w;x+=s){
      const on = ((x/s + y/s)|0)%2===0;
      imgCtx.fillStyle = on? '#a78bfa' : '#1e293b'; imgCtx.fillRect(x,y,s,s);
    }}
  }else if(name==='gradient'){
    const g = imgCtx.createLinearGradient(0,0,w,h);
    g.addColorStop(0,'#0ea5e9'); g.addColorStop(1,'#1e293b');
    imgCtx.fillStyle=g; imgCtx.fillRect(0,0,w,h);
  }
}
function loadImgFile(file){
  const img=new Image();
  img.onload=()=>{
    const {width:w,height:h}=imgCv;
    const r=Math.max(w/img.width,h/img.height);
    const sw=img.width*r, sh=img.height*r;
    const sx=(w-sw)/2, sy=(h-sh)/2;
    imgCtx.clearRect(0,0,w,h);
    imgCtx.drawImage(img,sx,sy,sw,sh);
  };
  img.src = URL.createObjectURL(file);
}
function embedImage(grid=8, decimals=2){
  const {width:w,height:h}=imgCv;
  const cw=Math.floor(w/grid), ch=Math.floor(h/grid);
  const out=[];
  for(let gy=0; gy<grid; gy++){
    for(let gx=0; gx<grid; gx++){
      const x=gx*cw, y=gy*ch;
      const img=imgCtx.getImageData(x,y,cw,ch).data;
      let R=0,G=0,B=0,cnt=img.length/4;
      for(let i=0;i<img.length;i+=4){ R+=img[i]; G+=img[i+1]; B+=img[i+2]; }
      R/=cnt; G/=cnt; B/=cnt;
      const q=Math.pow(10,decimals);
      out.push(Math.round(R/255*q)/q, Math.round(G/255*q)/q, Math.round(B/255*q)/q);
    }
  }
  return out;
}

/* =============== TEXT =============== */
function cleanText(s){
  return s.toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ').replace(/\s+/g,' ').trim();
}
// simple hashing trick
function embedText(s, D=64, clean=true){
  if(clean) s=cleanText(s);
  const v=new Float32Array(D);
  // tokenize simple words + character bigrams
  const toks = s.split(' ').filter(Boolean);
  for(const t of toks){
    let h=0; for(let i=0;i<t.length;i++) h = ((h<<5)-h) + t.charCodeAt(i) | 0;
    const idx = Math.abs(h)%D; v[idx]+=1;
    // char bigrams
    for(let i=0;i<t.length-1;i++){
      const bg = t.charCodeAt(i)*31 + t.charCodeAt(i+1);
      v[Math.abs(bg)%D]+=0.5;
    }
  }
  // l2 normalize
  let n=0; for(let i=0;i<D;i++) n+=v[i]*v[i]; n=Math.sqrt(n)||1;
  for(let i=0;i<D;i++) v[i]/=n;
  return Array.from(v);
}

/* =============== AUDIO =============== */
let audioCtx=null, micStream=null, analyser=null, synth=null, osc=null, gain=null;
function ensureAudio(){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
}
async function startMic(){
  ensureAudio();
  micStream = await navigator.mediaDevices.getUserMedia({audio:true});
  const src = audioCtx.createMediaStreamSource(micStream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  src.connect(analyser);
  $('#audStatus').textContent='Status: live (mic on)';
  $('#audStop').disabled=false;
}
function stopMic(){
  if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
  if(osc){ osc.stop(); osc.disconnect(); osc=null; }
  if(gain){ gain.disconnect(); gain=null; }
  $('#audStatus').textContent='Status: idle';
  $('#audStop').disabled=true;
}
function playPreset(kind){
  ensureAudio();
  stopMic();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  gain = audioCtx.createGain(); gain.gain.value=0.1;
  if(kind==='sine'){
    osc = audioCtx.createOscillator(); osc.type='sine'; osc.frequency.value=440;
    osc.connect(gain).connect(analyser).connect(audioCtx.destination); osc.start();
  }else if(kind==='chord'){
    const freqs=[261.63,329.63,392.00];
    const merger = audioCtx.createGain(); merger.gain.value=0.1;
    freqs.forEach(f=>{
      const o=audioCtx.createOscillator(); o.type='sine'; o.frequency.value=f;
      o.connect(merger);
      o.start();
      setTimeout(()=>o.stop(), 5000);
    });
    merger.connect(analyser).connect(audioCtx.destination);
  }else if(kind==='noise'){
    const node = audioCtx.createScriptProcessor(1024,1,1);
    node.onaudioprocess = e=>{
      const out = e.outputBuffer.getChannelData(0);
      for(let i=0;i<out.length;i++) out[i] = (Math.random()*2-1)*0.2;
    };
    node.connect(audioCtx.destination);
    // feed to analyser
    const dest = audioCtx.createGain(); dest.gain.value=0.0; // silent path
    node.connect(dest); dest.connect(analyser);
  }
  $('#audStatus').textContent='Status: playing preset';
}
function embedAudio(bands=64){
  if(!analyser){ return Array.from({length:bands}, ()=>0); }
  const N = analyser.frequencyBinCount;
  const freq = new Uint8Array(N);
  analyser.getByteFrequencyData(freq); // 0..255 magnitudes
  // average into bands
  const out = new Array(bands).fill(0);
  for(let i=0;i<bands;i++){
    const a = Math.floor(i*N/bands), b = Math.floor((i+1)*N/bands);
    let sum=0; for(let j=a;j<b;j++) sum+=freq[j];
    out[i] = sum/Math.max(1,(b-a))/255;
  }
  // l2 normalize
  let n=0; for(let i=0;i<bands;i++) n+=out[i]*out[i]; n=Math.sqrt(n)||1;
  for(let i=0;i<bands;i++) out[i]/=n;
  return out;
}

/* =============== Neighbors per modality =============== */
const galleries = {
  image: [], text: [], audio: []
};
let currentVec = null, currentMod = 'image';

function addToGallery(mod, label, vec){
  galleries[mod].push({label, vec});
}
function topK(mod, q, k=5){
  const arr = galleries[mod].map((g,i)=>({i, s: cosine(q, g.vec)}));
  arr.sort((a,b)=> b.s-a.s);
  return arr.slice(0, k);
}
function renderNN(){
  const k = parseInt($('#topk').value,10);
  const list = $('#nnList');
  if(!currentVec){ list.textContent='‚Äî'; return; }
  const top = topK(currentMod, currentVec, k);
  list.innerHTML = top.map(({i,s})=>{
    const g=galleries[currentMod][i];
    return `<div class="item"><span>${g.label}</span><span><code>${fmt(s)}</code></span></div>`;
  }).join('');
}

/* =============== Wiring UI =============== */
function switchTab(mod){
  currentMod = mod;
  $$('.tab').forEach(b=>b.setAttribute('aria-pressed', b.dataset.tab===mod ? 'true' : 'false'));
  $('.imagePane').hidden = mod!=='image';
  $('.textPane').hidden  = mod!=='text';
  $('.audioPane').hidden = mod!=='audio';
  $('#leftTitle').textContent = mod==='image' ? 'Image Input' : mod==='text' ? 'Text Input' : 'Audio Input';
  currentVec=null; $('#vecInfo').textContent='Vector: ‚Äî'; drawBars($('#chart'), [0], '#1a2742'); $('#nnList').textContent='‚Äî';
}
$$('.tab').forEach(b=> b.addEventListener('click', ()=> switchTab(b.dataset.tab)));

/* IMAGE events */
$('#imgCompute').addEventListener('click', ()=>{
  const grid = parseInt($('#imgGrid').value,10);
  const dec  = parseInt($('#imgQuant').value,10);
  const v = embedImage(grid, dec);
  currentVec = v; $('#vecInfo').textContent=`Vector: ${v.length} dims (Image)`;
  drawBars($('#chart'), v, getComputedStyle(document.documentElement).getPropertyValue('--img').trim());
  renderNN();
});
$('#imgUp').addEventListener('change', e=>{ if(e.target.files[0]) loadImgFile(e.target.files[0]); });
$$('.imagePane [data-preset]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ drawPresetImage(btn.dataset.preset); });
});

/* TEXT events */
$('#txtCompute').addEventListener('click', ()=>{
  const D = parseInt($('#txtDims').value,10);
  const cl = $('#txtClean').checked;
  const v = embedText($('#txtArea').value, D, cl);
  currentVec = v; $('#vecInfo').textContent=`Vector: ${v.length} dims (Text)`;
  drawBars($('#chart'), v, getComputedStyle(document.documentElement).getPropertyValue('--txt').trim());
  renderNN();
});
$$('.textPane [data-t]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t = btn.dataset.t;
    $('#txtArea').value =
      t==='dogs' ? 'A friendly golden retriever with a tennis ball.'
    : t==='flowers' ? 'A field of purple tulips near sunrise.'
    : 'People sitting on a bench in the city park.';
  });
});

/* AUDIO events */
$('#audMic').addEventListener('click', startMic);
$('#audStop').addEventListener('click', stopMic);
$$('.audioPane [data-a]').forEach(btn=> btn.addEventListener('click', ()=> playPreset(btn.dataset.a)));
$('#audCompute').addEventListener('click', ()=>{
  const bands = parseInt($('#audBands').value,10);
  const v = embedAudio(bands);
  currentVec = v; $('#vecInfo').textContent=`Vector: ${v.length} dims (Audio)`;
  drawBars($('#chart'), v, getComputedStyle(document.documentElement).getPropertyValue('--aud').trim());
  renderNN();
});

/* Neighbors button */
$('#nnRun').addEventListener('click', renderNN);

/* =============== Bootstrap =============== */
(function init(){
  // seed galleries with a few examples per modality
  // IMAGE seeds
  drawPresetImage('tulips'); addToGallery('image','üå∏ Tulips', embedImage(8,2));
  drawPresetImage('checker'); addToGallery('image','Checker', embedImage(8,2));
  drawPresetImage('gradient'); addToGallery('image','Gradient', embedImage(8,2));
  drawPresetImage('puppy'); addToGallery('image','üê∂ Puppy', embedImage(8,2));
  drawPresetImage('tulips'); // set back to tulips for default view

  // TEXT seeds
  addToGallery('text','Dogs sentence', embedText('A friendly golden retriever with a tennis ball.', 64, true));
  addToGallery('text','Flowers sentence', embedText('A field of purple tulips near sunrise.', 64, true));
  addToGallery('text','Park sentence', embedText('People sitting on a bench in the city park.', 64, true));
  addToGallery('text','Tech sentence', embedText('Vector databases enable fast nearest-neighbor search.', 64, true));

  // AUDIO seeds: generate once by synthesizing then snapshot (fallback if no audio context)
  try{
    playPreset('sine'); setTimeout(()=>{ addToGallery('audio','Sine 440Hz', embedAudio(64)); stopMic(); }, 500);
    playPreset('chord'); setTimeout(()=>{ addToGallery('audio','Chord triad', embedAudio(64)); stopMic(); }, 1200);
    playPreset('noise'); setTimeout(()=>{ addToGallery('audio','Noise', embedAudio(64)); stopMic(); }, 1800);
  }catch(e){
    // fallback static vectors
    addToGallery('audio','Sine 440Hz', Array.from({length:64}, (_,i)=> i===5?1:0));
    addToGallery('audio','Chord triad', Array.from({length:64}, (_,i)=> (i%10===0)?0.6:0.02));
    addToGallery('audio','Noise', Array.from({length:64}, ()=>Math.random()));
  }

  // default: image tab selected and chart cleared
  switchTab('image');
  drawPresetImage('tulips');
})();
</script>
</body>
</html>
